# Интеграция с 1С ЗУП

## Обзор

HR Desk поддерживает интеграцию с 1С ЗУП несколькими способами:

1. **Импорт из JSON файлов** (рекомендуется) — простой обмен через файлы, без публикации веб-сервера
2. **Синхронизация через OData API** — прямое подключение к веб-сервису 1С
3. **Webhook** — автоматическое создание HR-заявок при событиях в 1С

---

## Способ 1: Импорт из JSON файлов (рекомендуется)

Самый простой способ — 1С выгружает данные в JSON файл, HR Desk его загружает.

### Формат JSON файла

```json
{
  "departments": [
    {
      "id": "dept-001",
      "name": "Отдел продаж",
      "parent_id": null
    },
    {
      "id": "dept-002",
      "name": "Группа розничных продаж",
      "parent_id": "dept-001"
    }
  ],
  "positions": [
    {
      "id": "pos-001",
      "name": "Менеджер по продажам"
    },
    {
      "id": "pos-002",
      "name": "Старший менеджер"
    }
  ],
  "employees": [
    {
      "id": "emp-001",
      "full_name": "Иванов Иван Иванович",
      "birthday": "1990-05-15",
      "department_id": "dept-001",
      "position_id": "pos-001",
      "phone": "+7 999 123-45-67",
      "email": "ivanov@company.ru",
      "dismissed": false
    },
    {
      "id": "emp-002",
      "full_name": "Петров Пётр Петрович",
      "birthday": "1985-10-20",
      "department": "Отдел продаж",
      "position": "Старший менеджер",
      "new_hire": true,
      "effective_date": "2024-01-15"
    }
  ]
}
```

### Поля сотрудника

| Поле | Описание | Обязательное |
|------|----------|--------------|
| `id` | Уникальный ID из 1С (Ref_Key) | Да |
| `full_name` | ФИО | Да |
| `birthday` | Дата рождения (YYYY-MM-DD или DD.MM.YYYY) | Нет |
| `department_id` | ID отдела (или `department` — название) | Нет |
| `position_id` | ID должности (или `position` — название) | Нет |
| `phone` | Телефон | Нет |
| `email` | Email | Нет |
| `dismissed` | true если уволен | Нет |
| `new_hire` | true если новый приём | Нет |
| `effective_date` | Дата приёма/увольнения | Нет |

### Вариант A: Загрузка JSON через API

```bash
# Загрузка JSON напрямую
curl -X POST "http://hrdesk.teplocentral.local/api/v1/zup/import/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d @employees.json

# С созданием HR-заявок для приёма/увольнения
curl -X POST "http://hrdesk.teplocentral.local/api/v1/zup/import/json?create_hr_requests=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d @employees.json
```

Ответ:
```json
{
  "departments": {"created": 5, "updated": 0},
  "positions": {"created": 10, "updated": 0},
  "employees": {"created": 50, "updated": 0},
  "hr_requests": {"hire": 2, "fire": 1},
  "errors": []
}
```

### Вариант B: Загрузка файла

```bash
curl -X POST "http://hrdesk.teplocentral.local/api/v1/zup/import/file?create_hr_requests=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@employees.json"
```

### Вариант C: Обмен через сетевую папку (автоматизация)

Идеально для регулярной синхронизации:

1. **Настройте общую папку** — сетевой диск или папка на сервере

2. **В docker-compose.prod.yml** уже добавлен volume:
   ```yaml
   volumes:
     - ./exchange:/exchange:Z
   ```
   
   Создайте папку:
   ```bash
   mkdir -p /opt/hr_supporit/exchange
   ```

3. **1С выгружает** JSON файлы в эту папку (например, `employees_20240115.json`)

4. **HR Desk читает** файлы из папки:
   ```bash
   curl -X POST "http://hrdesk.teplocentral.local/api/v1/zup/import/directory?directory=/exchange&create_hr_requests=true" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

5. **Обработанные файлы** автоматически перемещаются в `/exchange/processed/`

### Автоматизация через cron

```bash
# Редактируем crontab
crontab -e

# Добавляем задачу — каждый час проверять папку обмена
0 * * * * curl -X POST "http://localhost:8000/api/v1/zup/import/directory?directory=/exchange&create_hr_requests=true" -H "Authorization: Bearer YOUR_TOKEN" >> /var/log/hrdesk-zup.log 2>&1
```

### Код выгрузки из 1С

```bsl
Процедура ВыгрузитьДанныеВHRDesk() Экспорт
    
    Данные = Новый Структура;
    
    // === Выгрузка отделов ===
    Отделы = Новый Массив;
    Выборка = Справочники.ПодразделенияОрганизаций.Выбрать();
    Пока Выборка.Следующий() Цикл
        Отдел = Новый Структура;
        Отдел.Вставить("id", Строка(Выборка.Ссылка.УникальныйИдентификатор()));
        Отдел.Вставить("name", Выборка.Наименование);
        Если ЗначениеЗаполнено(Выборка.Родитель) Тогда
            Отдел.Вставить("parent_id", Строка(Выборка.Родитель.УникальныйИдентификатор()));
        КонецЕсли;
        Отделы.Добавить(Отдел);
    КонецЦикла;
    Данные.Вставить("departments", Отделы);
    
    // === Выгрузка должностей ===
    Должности = Новый Массив;
    Выборка = Справочники.Должности.Выбрать();
    Пока Выборка.Следующий() Цикл
        Должность = Новый Структура;
        Должность.Вставить("id", Строка(Выборка.Ссылка.УникальныйИдентификатор()));
        Должность.Вставить("name", Выборка.Наименование);
        Должности.Добавить(Должность);
    КонецЦикла;
    Данные.Вставить("positions", Должности);
    
    // === Выгрузка сотрудников ===
    Сотрудники = Новый Массив;
    Выборка = Справочники.Сотрудники.Выбрать();
    Пока Выборка.Следующий() Цикл
        Сотрудник = Новый Структура;
        Сотрудник.Вставить("id", Строка(Выборка.Ссылка.УникальныйИдентификатор()));
        Сотрудник.Вставить("full_name", Выборка.Наименование);
        
        Если ЗначениеЗаполнено(Выборка.ДатаРождения) Тогда
            Сотрудник.Вставить("birthday", Формат(Выборка.ДатаРождения, "ДФ=yyyy-MM-dd"));
        КонецЕсли;
        
        Если ЗначениеЗаполнено(Выборка.Подразделение) Тогда
            Сотрудник.Вставить("department_id", Строка(Выборка.Подразделение.УникальныйИдентификатор()));
        КонецЕсли;
        
        Если ЗначениеЗаполнено(Выборка.Должность) Тогда
            Сотрудник.Вставить("position_id", Строка(Выборка.Должность.УникальныйИдентификатор()));
        КонецЕсли;
        
        Сотрудник.Вставить("phone", Выборка.Телефон);
        Сотрудник.Вставить("email", Выборка.Email);
        Сотрудник.Вставить("dismissed", Выборка.Уволен);
        
        Сотрудники.Добавить(Сотрудник);
    КонецЦикла;
    Данные.Вставить("employees", Сотрудники);
    
    // === Сохраняем в файл ===
    ЗаписьJSON = Новый ЗаписьJSON;
    ИмяФайла = "employees_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".json";
    ПутьКФайлу = "\\server\hrdesk_exchange\" + ИмяФайла;  // Путь к папке обмена
    
    ЗаписьJSON.ОткрытьФайл(ПутьКФайлу, , , Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Авто));
    ЗаписатьJSON(ЗаписьJSON, Данные);
    ЗаписьJSON.Закрыть();
    
    Сообщить("Выгружено: " + ПутьКФайлу);
    
КонецПроцедуры
```

### Выгрузка при проведении документов (приём/увольнение)

```bsl
// В модуле документа "Приём на работу" или "Увольнение"
Процедура ПриПроведении(Отказ)
    
    // ... стандартный код проведения ...
    
    // Выгрузка события в HR Desk
    ВыгрузитьСобытиеВHRDesk(ЭтотОбъект);
    
КонецПроцедуры

Процедура ВыгрузитьСобытиеВHRDesk(Документ)
    
    Данные = Новый Структура;
    Сотрудники = Новый Массив;
    
    Сотрудник = Новый Структура;
    Сотрудник.Вставить("id", Строка(Документ.Сотрудник.УникальныйИдентификатор()));
    Сотрудник.Вставить("full_name", Документ.Сотрудник.Наименование);
    
    Если ТипЗнч(Документ) = Тип("ДокументСсылка.ПриемНаРаботу") Тогда
        Сотрудник.Вставить("new_hire", Истина);
        Сотрудник.Вставить("effective_date", Формат(Документ.ДатаПриема, "ДФ=yyyy-MM-dd"));
        Сотрудник.Вставить("department", Документ.Подразделение.Наименование);
        Сотрудник.Вставить("position", Документ.Должность.Наименование);
    ИначеЕсли ТипЗнч(Документ) = Тип("ДокументСсылка.Увольнение") Тогда
        Сотрудник.Вставить("dismissed", Истина);
        Сотрудник.Вставить("effective_date", Формат(Документ.ДатаУвольнения, "ДФ=yyyy-MM-dd"));
    КонецЕсли;
    
    Сотрудники.Добавить(Сотрудник);
    Данные.Вставить("employees", Сотрудники);
    
    // Сохраняем в файл
    ЗаписьJSON = Новый ЗаписьJSON;
    ИмяФайла = "event_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".json";
    ПутьКФайлу = "\\server\hrdesk_exchange\" + ИмяФайла;
    
    ЗаписьJSON.ОткрытьФайл(ПутьКФайлу);
    ЗаписатьJSON(ЗаписьJSON, Данные);
    ЗаписьJSON.Закрыть();
    
КонецПроцедуры
```

---

## Способ 2: Синхронизация через OData API

Если у вас опубликован OData веб-сервис в 1С.

### Настройка переменных окружения

```env
# URL OData сервиса 1С ЗУП
ZUP_API_URL=http://1c-server/zup/odata/standard.odata

# Логин и пароль для доступа к OData API
ZUP_USERNAME=odata_user
ZUP_PASSWORD=odata_password
```

### Синхронизация

```bash
# Полная синхронизация
curl -X POST http://hrdesk.teplocentral.local/api/v1/zup/sync/all \
  -H "Authorization: Bearer YOUR_TOKEN"

# Только сотрудники
curl -X POST http://hrdesk.teplocentral.local/api/v1/zup/sync/employees \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## Способ 3: Webhook от 1С

Для автоматического создания HR-заявок при событиях в 1С.

### Настройка

```env
# Секретный токен для webhook (опционально)
ZUP_WEBHOOK_TOKEN=your-secret-token
```

### Формат запроса от 1С

```bash
POST /api/v1/zup/webhook
Content-Type: application/json
X-ZUP-Token: your-secret-token

{
  "event_type": "hire",
  "data": {
    "employee_id": "guid-from-1c",
    "full_name": "Иванов Иван Иванович",
    "department": "Отдел продаж",
    "position": "Менеджер",
    "effective_date": "2024-01-15"
  }
}
```

---

## Что происходит при импорте

### При обнаружении `new_hire: true`:
1. Создаётся/обновляется сотрудник в HR Desk
2. Создаётся HR-заявка типа "hire"
3. Создаётся тикет в SupporIT для онбординга

### При обнаружении `dismissed: true`:
1. Обновляется статус сотрудника на "dismissed"
2. Создаётся HR-заявка типа "fire"
3. Создаётся тикет в SupporIT для оффбординга

---

## Устранение неполадок

### Ошибки парсинга JSON

- Проверьте кодировку файла (должна быть UTF-8)
- Проверьте корректность JSON: https://jsonlint.com/

### Сотрудники не связываются с отделами

- Убедитесь, что `department_id` в employees соответствует `id` в departments
- Или используйте `department` с названием отдела

### Тикеты не создаются в SupporIT

- Проверьте настройки `SUPPORIT_API_URL` и `SUPPORIT_TOKEN`
- Проверьте логи: `docker compose -f docker-compose.prod.yml logs backend`

---

## Пример минимального JSON (только сотрудники)

Если отделы и должности уже есть в HR Desk:

```json
{
  "employees": [
    {
      "id": "12345",
      "full_name": "Сидоров Сидор Сидорович",
      "birthday": "1992-03-25",
      "department": "Бухгалтерия",
      "position": "Бухгалтер",
      "phone": "1234",
      "new_hire": true,
      "effective_date": "2024-01-20"
    }
  ]
}
```
